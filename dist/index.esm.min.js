import e from"react";import o from"vue";function t(t){if(t&&("function"==typeof t||"object"==typeof t)){class n extends e.Component{domRef;vm;isUnmount;constructor(o,t){super(o),this.domRef=e.createRef(),this.isUnmount=!1,this.resolveNeoProps=this.resolveNeoProps.bind(this)}componentDidMount(){const{neoData:e,neoMSTData:n,neoFunc:s}=this.resolveNeoProps(),{data:i,...c}=t="function"==typeof t?new t:t,a=r("function"==typeof i?i():i,e);this.vm=new o({...c,data:()=>a,props:r(s,{...c.props||{},...n})}),Object.keys(s).forEach(e=>{this.vm.$props[e]=s[e]}),this.domRef.current&&this.domRef.current.appendChild(this.vm.$mount().$el)}componentDidUpdate(){if(!this.isUnmount){const{neoData:e}=this.resolveNeoProps();this.vm&&(Object.keys(e).forEach(o=>{this.vm[o]=e[o]}),this.vm.$forceUpdate())}}componentWillUnmount(){this.isUnmount=!0,this.vm&&this.vm.$destroy()}resolveNeoProps(){let e={},o={},t={};return Object.keys(this.props).forEach(r=>{const n=this.props[r];"function"==typeof n?e[r]=n:!function(e){if(!e)return!1;return!!(e.$treenode||e.$mstObservable||e.$modelType||e.$modelId)||"[object Proxy]"===Object.prototype.toString.call(e)}(n)?o[r]=n:t[r]=n}),{neoData:o,neoMSTData:t,neoFunc:e}}reload(){this.vm&&this.vm.reload?this.vm.reload():console.warn("自定义组件暂不支持reload动作。")}doAction(e,o){this.vm&&this.vm.doAction?this.vm.doAction(e,o):console.warn("自定义组件中不存在 doAction。")}render(){return e.createElement("div",{ref:this.domRef})}}return n}}function r(e,o,t=!0){const r=function(e,o=!0){const t=e&&e.__super?Object.create(e.__super,{__super:{value:e.__super,writable:!1,enumerable:!1}}):Object.create(Object.prototype);return o&&e&&Object.keys(e).forEach(o=>t[o]=e[o]),t}(e,t);return o&&Object.keys(o).forEach(e=>r[e]=o[e]),r}const n="[neo-register]";function s(e){return"object"==typeof e&&(e._compiled&&e.components||e.__file&&e.__file.endsWith(".vue"))}var i,c;function a(e){return s(e)?t(e):e}function u(e,o){if(e&&function(e){let o=!1;if(!e)return!1;const t=new e;return t.label?t.tags?Array.isArray(t.tags)?(t.icon||Object.assign(e.prototype,{icon:"https://neo-widgets.bj.bcebos.com/custom-widget.svg"}),o=!0):console.error(`${n} / registerNeoEditorModel: 自定义组件注册失败，组件分类（tags）格式异常。`):console.error(`${n} / registerNeoEditorModel: 自定义组件注册失败，组件分类（tags）不能为空。`):console.error(`${n} / registerNeoEditorModel: 自定义组件注册失败，名称（label）不能为空。`),o}(e)){const t=o||(new e).cmpType;t||console.error(`${n} / registerNeoEditorModel: 自定义组件注册失败，cmpType 不能为空。`);const r=new e;if(Object.assign(e.prototype,{custom:!0,exposedToDesigner:r.exposedToDesigner??!0,namespace:r.namespace??"neo-cmp-cli",enableDuplicate:r.enableDuplicate??!0,cmpType:t}),window&&window.postMessage){const o=function(e,o){window&&!window.NEOEditorCustomModels&&(window.NEOEditorCustomModels={});if(!window.NEOEditorCustomModels[e])return window.NEOEditorCustomModels[e]=o,e;console.error(`${n}注册自定义组件模型失败，已存在重名插件(${e})。`);return null}(t,e);o&&(console.info(`${n}触发注册自定义组件模型(${t})事件`),window.postMessage({type:"neo-model-register-event",eventMsg:`${n}注册一个 neo-editor 自定义组件模型`,cmpType:t},"*"))}}}function m(e,o){if(!e)return;const r={cmpType:"",usage:i.renderer,weight:0};var a;if(o&&(a=o,"String"===Object.prototype.toString.call(a).slice(8,-1))?Object.assign(r,{cmpType:o}):Object.assign(r,o),r&&!r.cmpType)console.error(`${n} / registerNeoCmp: 自定义组件注册失败，cmpType 不能为空。`);else{r.framework=r.framework?function(e){let o=c.react;if(!e)return o;let t=e.toLowerCase().trim();switch(t){case"jquery":case"jq":t=c.jquery;break;case"vue2":case"vue 2":case"vue2.0":case"vue 2.0":t=c.vue2;break;case"vue":case"vue3":case"vue 3":case"vue3.0":case"vue 3.0":t=c.vue3,console.error(`${n} 暂不支持 vue3.0 技术栈。`);break;default:t=c.react}return t}(r.framework):s(e)?"vue2":"react",r.usage=function(e){let o=i.renderer;if(!e)return o;let t=e.toLowerCase().trim();switch(t){case"renderer":case"renderers":default:t=i.renderer;break;case"formitem":case"form-item":case"form item":t=i.formitem}return t}(r.usage);const o={renderer:()=>{},formitem:()=>{}},a={react:e=>e,vue2:t,vue3:t}[r.framework](e);if(o[r.usage]){if(window&&window.postMessage){const e=function(e,o){window&&!window.NeoCustomCmps&&(window.NeoCustomCmps={});if(!window.NeoCustomCmps[e])return window.NeoCustomCmps[e]=o,e;console.error(`${n} / registerNeoCmp: 自定义组件注册失败，已存在重名渲染器(${e})。`);return null}(r.cmpType,{cmpType:r.cmpType,weight:r.weight,usage:r.usage,framework:r.framework,component:a,config:r});e&&(console.info(`${n}触发注册自定义组件(${e})事件`),window.postMessage({type:"neo-cmp-register-event",eventMsg:`${n}注册一个自定义组件`,neoRenderer:{cmpType:e,weight:r.weight,usage:r.usage,config:r}},"*"))}}else console.error(`${n} / registerNeoCmp: 自定义组件注册失败，暂不支持 ${r.usage} 组件类型。`)}}!function(e){e.renderer="renderer",e.formitem="formitem"}(i||(i={})),function(e){e.react="react",e.vue2="vue2",e.vue3="vue3",e.jquery="jquery"}(c||(c={}));export{a as autoConvertVueComponent,t as createVue2Component,m as registerNeoCmp,u as registerNeoEditorModel};
