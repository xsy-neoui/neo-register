import e from"react";import o from"vue";function t(e,o,t=!0){const r=function(e,o=!0){const t=e&&e.__super?Object.create(e.__super,{__super:{value:e.__super,writable:!1,enumerable:!1}}):Object.create(Object.prototype);return o&&e&&Object.keys(e).forEach(o=>t[o]=e[o]),t}(e,t);return o&&Object.keys(o).forEach(e=>r[e]=o[e]),r}const r="[neo-register]";function n(e){return"object"==typeof e&&(e._compiled&&e.components||e.__file&&e.__file.endsWith(".vue"))}var s,i;function c(e,o,t){if(e&&function(e){let o=!1;if(!e)return!1;const t=new e;return t.label?t.tags&&!Array.isArray(t.tags)?console.error(`${r} / registerNeoEditorModel: 自定义组件注册失败，组件分类（tags）格式异常。`):(t.iconSrc||Object.assign(e.prototype,{iconSrc:"https://neo-widgets.bj.bcebos.com/custom-widget.svg"}),o=!0):console.error(`${r} / registerNeoEditorModel: 自定义组件注册失败，名称（label）不能为空。`),o}(e)){const n=o||(new e).cmpType;n||console.error(`${r} / registerNeoEditorModel: 自定义组件注册失败，cmpType 不能为空。`);const s=t||{},i=new e;if(Object.assign(e.prototype,{...i,cmpType:n,custom:!0,tags:i.tags??s.tags??["自定义组件"],targetPage:i.targetPage??s.targetPage??["customPage"],exposedToDesigner:i.exposedToDesigner??s.exposedToDesigner??!0,namespace:i.namespace??s.namespace??"neo-cmp-cli",enableDuplicate:i.enableDuplicate??s.enableDuplicate??!0}),window&&window.postMessage){const o=function(e,o){window&&!window.NEOEditorCustomModels&&(window.NEOEditorCustomModels={});if(!window.NEOEditorCustomModels[e])return window.NEOEditorCustomModels[e]=o,e;console.error(`${r}注册自定义组件模型失败，已存在重名插件(${e})。`);return null}(n,e);o&&(console.info(`${r}触发注册自定义组件模型(${n})事件`),window.postMessage({type:"neo-model-register-event",eventMsg:`${r}注册一个 neo-editor 自定义组件模型`,cmpType:n},"*"))}}}function a(r){if(r&&("function"==typeof r||"object"==typeof r)){class n extends e.Component{domRef;vm;isUnmount;constructor(o,t){super(o),this.domRef=e.createRef(),this.isUnmount=!1,this.resolveNeoProps=this.resolveNeoProps.bind(this)}componentDidMount(){const{neoData:e,neoMSTData:n,neoFunc:s}=this.resolveNeoProps(),{data:i,...c}=r="function"==typeof r?new r:r,a=t("function"==typeof i?i():i,e);this.vm=new o({...c,data:()=>a,props:t(s,{...c.props||{},...n})}),Object.keys(s).forEach(e=>{this.vm.$props[e]=s[e]}),this.domRef.current&&this.domRef.current.appendChild(this.vm.$mount().$el)}componentDidUpdate(){if(!this.isUnmount){const{neoData:e}=this.resolveNeoProps();this.vm&&(Object.keys(e).forEach(o=>{this.vm[o]=e[o]}),this.vm.$forceUpdate())}}componentWillUnmount(){this.isUnmount=!0,this.vm&&this.vm.$destroy()}resolveNeoProps(){let e={},o={},t={};return Object.keys(this.props).forEach(r=>{const n=this.props[r];var s;"function"==typeof n?e[r]=n:(s=n)&&(s.$treenode||s.$mstObservable||s.$modelType||s.$modelId||"[object Proxy]"===Object.prototype.toString.call(s))?t[r]=n:o[r]=n}),{neoData:o,neoMSTData:t,neoFunc:e}}reload(){this.vm&&this.vm.reload?this.vm.reload():console.warn("自定义组件暂不支持reload动作。")}doAction(e,o){this.vm&&this.vm.doAction?this.vm.doAction(e,o):console.warn("自定义组件中不存在 doAction。")}render(){return e.createElement("div",{ref:this.domRef})}}return n}}function u(e){return n(e)?a(e):e}function m(e,o){if(!e)return;const t={cmpType:"",usage:s.renderer,weight:0};var c;if(o&&(c=o,"String"===Object.prototype.toString.call(c).slice(8,-1))?Object.assign(t,{cmpType:o}):Object.assign(t,o),t&&!t.cmpType)console.error(`${r} / registerNeoCmp: 自定义组件注册失败，cmpType 不能为空。`);else{t.framework=t.framework?function(e){let o=i.react;if(!e)return o;let t=e.toLowerCase().trim();switch(t){case"jquery":case"jq":t=i.jquery;break;case"vue2":case"vue 2":case"vue2.0":case"vue 2.0":t=i.vue2;break;case"vue":case"vue3":case"vue 3":case"vue3.0":case"vue 3.0":t=i.vue3,console.error(`${r} 暂不支持 vue3.0 技术栈。`);break;default:t=i.react}return t}(t.framework):n(e)?"vue2":"react",t.usage=function(e){let o=s.renderer;if(!e)return o;let t=e.toLowerCase().trim();switch(t){case"renderer":case"renderers":default:t=s.renderer;break;case"formitem":case"form-item":case"form item":t=s.formitem}return t}(t.usage);const o={renderer:()=>{},formitem:()=>{}},c={react:e=>e,vue2:a,vue3:a}[t.framework](e);if(o[t.usage]){if(window&&window.postMessage){const e=function(e,o){window&&!window.NeoCustomCmps&&(window.NeoCustomCmps={});if(!window.NeoCustomCmps[e])return window.NeoCustomCmps[e]=o,e;console.error(`${r} / registerNeoCmp: 自定义组件注册失败，已存在重名渲染器(${e})。`);return null}(t.cmpType,{cmpType:t.cmpType,weight:t.weight,usage:t.usage,framework:t.framework,component:c,config:t});e&&(console.info(`${r}触发注册自定义组件(${e})事件`),window.postMessage({type:"neo-cmp-register-event",eventMsg:`${r}注册一个自定义组件`,neoRenderer:{cmpType:e,weight:t.weight,usage:t.usage,config:t}},"*"))}}else console.error(`${r} / registerNeoCmp: 自定义组件注册失败，暂不支持 ${t.usage} 组件类型。`)}}!function(e){e.renderer="renderer",e.formitem="formitem"}(s||(s={})),function(e){e.react="react",e.vue2="vue2",e.vue3="vue3",e.jquery="jquery"}(i||(i={}));export{u as autoConvertVueComponent,a as createVue2Component,m as registerNeoCmp,c as registerNeoEditorModel};
