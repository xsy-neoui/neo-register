import e from"react";import o from"vue";function r(e,o,r=!0){const t=function(e,o=!0){const r=e&&e.__super?Object.create(e.__super,{__super:{value:e.__super,writable:!1,enumerable:!1}}):Object.create(Object.prototype);return o&&e&&Object.keys(e).forEach(o=>r[o]=e[o]),r}(e,r);return o&&Object.keys(o).forEach(e=>t[e]=o[e]),t}const t="[neo-widget]";var n,s;function i(e,o){if(e&&function(e){let o=!1;if(!e)return!1;const r=new e;return r.cmpType?r.label?r.tags?Array.isArray(r.tags)?(r.icon||Object.assign(e.prototype,{icon:"https://neo-widgets.bj.bcebos.com/custom-widget.svg"}),o=!0):console.error(`${t} / registerNeoEditorPlugin: 自定义组件注册失败，组件分类（tags）格式异常。`):console.error(`${t} / registerNeoEditorPlugin: 自定义组件注册失败，组件分类（tags）不能为空。`):console.error(`${t} / registerNeoEditorPlugin: 自定义组件注册失败，名称（label）不能为空。`):console.error(`${t} / registerNeoEditorPlugin: 自定义组件注册失败，cmpType 不能为空。`),o}(e)){const r=o||(new e).cmpType,n=new e;if(Object.assign(e.prototype,{custom:!0,exposedToDesigner:n.exposedToDesigner??!0,namespace:n.namespace??"neo-widget-cli",cmpType:r}),window&&window.postMessage){const o=function(e,o){window&&!window.NEOEditorCustomPlugins&&(window.NEOEditorCustomPlugins={});if(!window.NEOEditorCustomPlugins[e])return window.NEOEditorCustomPlugins[e]=o,e;console.error(`${t}注册自定义插件失败，已存在重名插件(${e})。`);return null}(r,e);o&&(console.info(`${t}触发注册自定义插件(${r})事件`),window.postMessage({type:"neo-plugin-register-event",eventMsg:`${t}注册一个 neo-editor 自定义插件`,cmpType:r},"*"))}}}function c(t){if(t&&("function"==typeof t||"object"==typeof t)){class n extends e.Component{domRef;vm;isUnmount;constructor(o,r){super(o),this.domRef=e.createRef(),this.isUnmount=!1,this.resolveNeoProps=this.resolveNeoProps.bind(this)}componentDidMount(){const{neoData:e,neoMSTData:n,neoFunc:s}=this.resolveNeoProps(),{data:i,...c}=t="function"==typeof t?new t:t,u=r("function"==typeof i?i():i,e);this.vm=new o({...c,data:()=>u,props:r(s,{...c.props||{},...n})}),Object.keys(s).forEach(e=>{this.vm.$props[e]=s[e]}),this.domRef.current&&this.domRef.current.appendChild(this.vm.$mount().$el)}componentDidUpdate(){if(!this.isUnmount){const{neoData:e}=this.resolveNeoProps();this.vm&&(Object.keys(e).forEach(o=>{this.vm[o]=e[o]}),this.vm.$forceUpdate())}}componentWillUnmount(){this.isUnmount=!0,this.vm&&this.vm.$destroy()}resolveNeoProps(){let e={},o={},r={};return Object.keys(this.props).forEach(t=>{const n=this.props[t];var s;"function"==typeof n?e[t]=n:(s=n)&&(s.$treenode||s.$mstObservable||s.$modelType||s.$modelId||"[object Proxy]"===Object.prototype.toString.call(s))?r[t]=n:o[t]=n}),{neoData:o,neoMSTData:r,neoFunc:e}}reload(){this.vm&&this.vm.reload?this.vm.reload():console.warn("自定义组件暂不支持reload动作。")}doAction(e,o){this.vm&&this.vm.doAction?this.vm.doAction(e,o):console.warn("自定义组件中不存在 doAction。")}render(){return e.createElement("div",{ref:this.domRef})}}return n}}function u(e,o){if(!e)return;const r={cmpType:"",usage:n.renderer,weight:0};var i;if(o&&(i=o,"String"===Object.prototype.toString.call(i).slice(8,-1))?Object.assign(r,{cmpType:o}):Object.assign(r,o),r&&!r.cmpType)console.error(`${t} / registerRendererByType: 自定义组件注册失败，cmpType 不能为空。`);else{r.framework=r.framework?function(e){let o=s.react;if(!e)return o;let r=e.toLowerCase().trim();switch(r){case"jquery":case"jq":r=s.jquery;break;case"vue2":case"vue 2":case"vue2.0":case"vue 2.0":r=s.vue2;break;case"vue":case"vue3":case"vue 3":case"vue3.0":case"vue 3.0":r=s.vue3,console.error("neo-widget 暂不支持 vue3.0 技术栈。");break;default:r=s.react}return r}(r.framework):function(e){return"object"==typeof e&&(e._compiled&&e.components||e.__file&&e.__file.endsWith(".vue"))}(e)?"vue2":"react",r.usage=function(e){let o=n.renderer;if(!e)return o;let r=e.toLowerCase().trim();switch(r){case"renderer":case"renderers":default:r=n.renderer;break;case"formitem":case"form-item":case"form item":r=n.formitem}return r}(r.usage);const o={renderer:()=>{},formitem:()=>{}},i={react:e=>e,vue2:c,vue3:c}[r.framework](e);if(o[r.usage]){if(window&&window.postMessage){const e=function(e,o){window&&!window.NeoCustomRenderers&&(window.NeoCustomRenderers={});if(!window.NeoCustomRenderers[e])return window.NeoCustomRenderers[e]=o,e;console.error(`${t} / registerRendererByType: 自定义组件注册失败，已存在重名渲染器(${e})。`);return null}(r.cmpType,{cmpType:r.cmpType,weight:r.weight,usage:r.usage,framework:r.framework,component:i,config:r});e&&(console.info(`${t}触发注册自定义组件(${e})事件`),window.postMessage({type:"neo-renderer-register-event",eventMsg:`${t}注册一个自定义组件`,neoRenderer:{cmpType:e,weight:r.weight,usage:r.usage,config:r}},"*"))}}else console.error(`${t} / registerRendererByType: 自定义组件注册失败，暂不支持 ${r.usage} 组件类型。`)}}!function(e){e.renderer="renderer",e.formitem="formitem"}(n||(n={})),function(e){e.react="react",e.vue2="vue2",e.vue3="vue3",e.jquery="jquery"}(s||(s={}));export{c as createVue2Component,i as registerNeoEditorPlugin,u as registerRendererByType};
