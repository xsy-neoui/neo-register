import e from"react";import o from"vue";function t(e,o,t=!0){const r=function(e,o=!0){const t=e&&e.__super?Object.create(e.__super,{__super:{value:e.__super,writable:!1,enumerable:!1}}):Object.create(Object.prototype);return o&&e&&Object.keys(e).forEach(o=>t[o]=e[o]),t}(e,t);return o&&Object.keys(o).forEach(e=>r[e]=o[e]),r}const r="[neo-register]";var s,n;function i(e,o){if(e&&function(e){let o=!1;if(!e)return!1;const t=new e;return t.cmpType?t.label?t.tags?Array.isArray(t.tags)?(t.icon||Object.assign(e.prototype,{icon:"https://neo-widgets.bj.bcebos.com/custom-widget.svg"}),o=!0):console.error(`${r} / registerNeoEditorModel: 自定义组件注册失败，组件分类（tags）格式异常。`):console.error(`${r} / registerNeoEditorModel: 自定义组件注册失败，组件分类（tags）不能为空。`):console.error(`${r} / registerNeoEditorModel: 自定义组件注册失败，名称（label）不能为空。`):console.error(`${r} / registerNeoEditorModel: 自定义组件注册失败，cmpType 不能为空。`),o}(e)){const t=o||(new e).cmpType,s=new e;if(Object.assign(e.prototype,{custom:!0,exposedToDesigner:s.exposedToDesigner??!0,namespace:s.namespace??"neo-cmp-cli",cmpType:t}),window&&window.postMessage){const o=function(e,o){window&&!window.NEOEditorCustomModels&&(window.NEOEditorCustomModels={});if(!window.NEOEditorCustomModels[e])return window.NEOEditorCustomModels[e]=o,e;console.error(`${r}注册自定义组件模型失败，已存在重名插件(${e})。`);return null}(t,e);o&&(console.info(`${r}触发注册自定义组件模型(${t})事件`),window.postMessage({type:"neo-model-register-event",eventMsg:`${r}注册一个 neo-editor 自定义组件模型`,cmpType:t},"*"))}}}function c(r){if(r&&("function"==typeof r||"object"==typeof r)){class s extends e.Component{domRef;vm;isUnmount;constructor(o,t){super(o),this.domRef=e.createRef(),this.isUnmount=!1,this.resolveNeoProps=this.resolveNeoProps.bind(this)}componentDidMount(){const{neoData:e,neoMSTData:s,neoFunc:n}=this.resolveNeoProps(),{data:i,...c}=r="function"==typeof r?new r:r,a=t("function"==typeof i?i():i,e);this.vm=new o({...c,data:()=>a,props:t(n,{...c.props||{},...s})}),Object.keys(n).forEach(e=>{this.vm.$props[e]=n[e]}),this.domRef.current&&this.domRef.current.appendChild(this.vm.$mount().$el)}componentDidUpdate(){if(!this.isUnmount){const{neoData:e}=this.resolveNeoProps();this.vm&&(Object.keys(e).forEach(o=>{this.vm[o]=e[o]}),this.vm.$forceUpdate())}}componentWillUnmount(){this.isUnmount=!0,this.vm&&this.vm.$destroy()}resolveNeoProps(){let e={},o={},t={};return Object.keys(this.props).forEach(r=>{const s=this.props[r];var n;"function"==typeof s?e[r]=s:(n=s)&&(n.$treenode||n.$mstObservable||n.$modelType||n.$modelId||"[object Proxy]"===Object.prototype.toString.call(n))?t[r]=s:o[r]=s}),{neoData:o,neoMSTData:t,neoFunc:e}}reload(){this.vm&&this.vm.reload?this.vm.reload():console.warn("自定义组件暂不支持reload动作。")}doAction(e,o){this.vm&&this.vm.doAction?this.vm.doAction(e,o):console.warn("自定义组件中不存在 doAction。")}render(){return e.createElement("div",{ref:this.domRef})}}return s}}function a(e,o){if(!e)return;const t={cmpType:"",usage:s.renderer,weight:0};var i;if(o&&(i=o,"String"===Object.prototype.toString.call(i).slice(8,-1))?Object.assign(t,{cmpType:o}):Object.assign(t,o),t&&!t.cmpType)console.error(`${r} / registerNeoCmp: 自定义组件注册失败，cmpType 不能为空。`);else{t.framework=t.framework?function(e){let o=n.react;if(!e)return o;let t=e.toLowerCase().trim();switch(t){case"jquery":case"jq":t=n.jquery;break;case"vue2":case"vue 2":case"vue2.0":case"vue 2.0":t=n.vue2;break;case"vue":case"vue3":case"vue 3":case"vue3.0":case"vue 3.0":t=n.vue3,console.error(`${r} 暂不支持 vue3.0 技术栈。`);break;default:t=n.react}return t}(t.framework):function(e){return"object"==typeof e&&(e._compiled&&e.components||e.__file&&e.__file.endsWith(".vue"))}(e)?"vue2":"react",t.usage=function(e){let o=s.renderer;if(!e)return o;let t=e.toLowerCase().trim();switch(t){case"renderer":case"renderers":default:t=s.renderer;break;case"formitem":case"form-item":case"form item":t=s.formitem}return t}(t.usage);const o={renderer:()=>{},formitem:()=>{}},i={react:e=>e,vue2:c,vue3:c}[t.framework](e);if(o[t.usage]){if(window&&window.postMessage){const e=function(e,o){window&&!window.NeoCustomCmps&&(window.NeoCustomCmps={});if(!window.NeoCustomCmps[e])return window.NeoCustomCmps[e]=o,e;console.error(`${r} / registerNeoCmp: 自定义组件注册失败，已存在重名渲染器(${e})。`);return null}(t.cmpType,{cmpType:t.cmpType,weight:t.weight,usage:t.usage,framework:t.framework,component:i,config:t});e&&(console.info(`${r}触发注册自定义组件(${e})事件`),window.postMessage({type:"neo-cmp-register-event",eventMsg:`${r}注册一个自定义组件`,neoRenderer:{cmpType:e,weight:t.weight,usage:t.usage,config:t}},"*"))}}else console.error(`${r} / registerNeoCmp: 自定义组件注册失败，暂不支持 ${t.usage} 组件类型。`)}}!function(e){e.renderer="renderer",e.formitem="formitem"}(s||(s={})),function(e){e.react="react",e.vue2="vue2",e.vue3="vue3",e.jquery="jquery"}(n||(n={}));export{c as createVue2Component,a as registerNeoCmp,i as registerNeoEditorModel};
